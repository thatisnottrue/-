<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>전염병 확산 게임 - v3.1 (SVG 169타일 · 회복 시스템 적용)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f5f7;
      --panel-bg: #ffffff;
      --border: #d0d0dd;
      --accent: #4a6fff;
      --text-main: #222222;
      --text-muted: #666666;
      --radius-lg: 16px;
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.05);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }
    .app {
      width: 100%;
      max-width: 1400px;
      min-height: 100vh;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    header {
      background: var(--panel-bg);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    header h1 {
      font-size: 1.1rem;
      font-weight: 700;
    }
    .header-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      background: #eef0ff;
      color: var(--accent);
      font-weight: 600;
      font-size: 0.75rem;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      transition: transform 0.08s ease;
      box-shadow: 0 4px 12px rgba(74, 111, 255, 0.35);
    }
    .btn.secondary {
      background: #ececf5;
      color: var(--text-main);
      box-shadow: none;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(74, 111, 255, 0.5);
    }
    main.layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 2.8fr) minmax(0, 1.2fr);
      gap: 12px;
      min-height: 0;
    }
    .map-panel {
      background: var(--panel-bg);
      border-radius: var(--radius-lg);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      box-shadow: var(--shadow-soft);
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
    }
    .panel-header span:last-child {
      color: var(--text-muted);
    }

    .svg-map {
      position: relative;
      flex: 1;
      overflow: auto;
      background: #f9fafb;
      border-radius: 10px;
    }
    .svg-map svg {
      width: 100%;
      height: auto;
      display: block;
    }

    #overlayLayer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .tile-overlay {
      position: absolute;
      transform: translate(-50%, -50%);
      font-size: 0.55rem;
      border-radius: 4px;
      padding: 2px 3px;
      border: none;
      pointer-events: auto;
      background: transparent;
    }

    .tile-overlay.selected {
      box-shadow: 0 0 0 2px rgba(74, 111, 255, 0.7);
    }

    .tile-bottom {
      display: flex;
      flex-direction: column;
      gap: 1px;
      background: transparent;
    }

    .tile-bottom span.label {
      color: var(--text-muted);
    }

    .tile-pieces {
      margin-top: 1px;
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }

    .piece {
      width: 20px;
      height: 20px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: none;
    }
    .piece.player {
      background-image: url("./assets/player-normal.svg");
    }
    .piece.infected {
      background-image: url("./assets/player-infected.svg");
    }
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--panel-bg);
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .stat-item {
      border: 1px solid #ececf5;
      border-radius: 10px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.8rem;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 0.75rem;
    }

    .stat-value {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .stat-note {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .stat-history {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed #ccc;
      font-size: 0.75rem;
      max-height: 120px;
      overflow-y: auto;
    }

    .log-list {
      list-style: none;
      max-height: 160px;
      overflow-y: auto;
      font-size: 0.8rem;
    }

    footer {
      font-size: 0.75rem;
      color: var(--text-muted);
      padding: 4px;
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <h1>전염병 확산 게임 — 싱글플레이 프로토타입 v3.1</h1>
      <div class="header-right">
        <span class="badge">GitHub + Netlify 배포</span>
        <span>플레이어 25명 · 시민 300000명 · 타일 169개</span>
        <button class="btn secondary" id="addDummyLogBtn">테스트 로그 추가</button>
        <button class="btn secondary" id="newGameBtn">새 게임</button>
        <button class="btn" id="nextTurnBtn">다음 턴 진행</button>
      </div>
    </header>

    <main class="layout">
      <section class="map-panel">
        <div class="panel-header">
          <span>SVG Hex Map</span>
          <span>169개 타일 · 6방향 이동</span>
        </div>

        <div class="svg-map" id="svgMapContainer">
          <div id="overlayLayer"></div>
        </div>
      </section>

      <section class="side-panel">
        <div class="card">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-label">전체 인구</div>
              <div class="stat-value" id="statTotal">300025</div>
              <div class="stat-note">플레이어 25 + 시민 300000</div>
            </div>

            <div class="stat-item">
              <div class="stat-label">감염 인구</div>
              <div class="stat-value" id="statInfected">0</div>
              <div class="stat-note">감염 플레이어 + 시민 포함</div>
            </div>

            <div class="stat-item">
              <div class="stat-label">감염률</div>
              <div class="stat-value" id="statRatio">0%</div>
              <div class="stat-note">전체 대비 감염 비율</div>
            </div>

            <div class="stat-item">
              <div class="stat-label">현재 턴</div>
              <div class="stat-value" id="statTurn">1</div>
              <div class="stat-note">턴 제한 없음</div>
            </div>

            <div class="stat-item">
              <div class="stat-label">열린 상자 수</div>
              <div class="stat-value" id="statOpenedChests">0 / 8</div>
              <div class="stat-note">8개 열면 백신 완성</div>
            </div>

            <div class="stat-item">
              <div class="stat-label">백신 상태</div>
              <div class="stat-value" id="statVaccineStatus">개발 전</div>
              <div class="stat-note">
                <label><input type="checkbox" id="vaccineToggle" checked /> 백신 시스템 사용</label>
              </div>
            </div>
          </div>

          <div class="stat-history" id="infectedHistoryBox">
            <div><b>턴별 누적 감염 인구</b></div>
            <div>데이터 없음</div>
          </div>

          <div id="selectedPlayerInfo" style="font-size:0.78rem; margin-top:4px;">
            선택된 플레이어: 없음
          </div>
        </div>

        <div class="card">
          <div style="font-weight:600;">턴 로그</div>
          <ul class="log-list" id="logList"></ul>
        </div>
      </section>
    </main>

    <footer>
      ※ SVG 맵 기반 감염 시뮬레이터 프로토타입 버전입니다.
    </footer>
  </div>

<script>
/* =============================
   1. 게임 설정
============================= */
const GameConfig = {
  NUM_TILES: 169,
  NUM_CITIZENS: 300000,
  NUM_PLAYERS: 25,
  BASE_INFECTION_RATE: 0.8,
  PLAYER_INFECTION_RATE: 1.0,
  RECOVERY_TURNS: 4,
  VACCINE_REDUCTION_FACTOR: 0.1,
  CHESTS_REQUIRED_FOR_VACCINE: 8
};

/* =============================
   2. 게임 상태
============================= */
const GameState = {
  currentTurn: 1,
  entities: [],
  tileCenters: [],
  tileElements: [],
  neighborMap: [],
  selectedPlayer: null,
  selectedPlayerTileIndex: null,
  playersMovedThisTurn: new Set(),

  // 백신 관련
  activeChestTiles: new Set(),
  chestWave: 0,
  openedChestCount: 0,
  vaccineActive: false,
  vaccineFeatureEnabled: true,

  // 기록
  historyCumulativeInfected: [],
  lastRecordedTurn: 0
};
/* =============================
   3. UI 요소 가져오기
============================= */
const UI = {
  svgMapContainer: document.getElementById("svgMapContainer"),
  overlayLayer: document.getElementById("overlayLayer"),

  logList: document.getElementById("logList"),
  statTurn: document.getElementById("statTurn"),
  statInfected: document.getElementById("statInfected"),
  statRatio: document.getElementById("statRatio"),
  statTotal: document.getElementById("statTotal"),
  statOpenedChests: document.getElementById("statOpenedChests"),
  statVaccineStatus: document.getElementById("statVaccineStatus"),
  infectedHistoryBox: document.getElementById("infectedHistoryBox"),

  vaccineToggle: document.getElementById("vaccineToggle"),
  selectedPlayerInfo: document.getElementById("selectedPlayerInfo"),

  addDummyLogBtn: document.getElementById("addDummyLogBtn"),
  nextTurnBtn: document.getElementById("nextTurnBtn"),
  newGameBtn: document.getElementById("newGameBtn")
};

UI.statTotal.textContent =
  GameConfig.NUM_CITIZENS + GameConfig.NUM_PLAYERS;

/* =============================
   4. 유틸 함수
============================= */
const randInt = max => Math.floor(Math.random() * max);

function addLog(msg) {
  const li = document.createElement("li");
  li.textContent = `T${GameState.currentTurn} ${msg}`;
  UI.logList.appendChild(li);
  UI.logList.scrollTop = UI.logList.scrollHeight;
}

function addInitialLog() {
  addLog("게임이 초기화되었습니다. 감염자 1명 무작위 설정됨.");
}

function computeInfectedCount() {
  return GameState.entities.filter(e => e.infected).length;
}

/* =============================
   5. SVG 맵 로드
============================= */
function loadSVGMap() {
  return fetch("./assets/map.svg")
    .then(res => res.text())
    .then(svgText => {
      UI.svgMapContainer.insertAdjacentHTML("afterbegin", svgText);
      const svgElement = UI.svgMapContainer.querySelector("svg");
      if (!svgElement) {
        console.error("SVG 파일을 찾을 수 없습니다.");
        return;
      }

      const paths = svgElement.querySelectorAll("path[data-tile-index]");
      GameConfig.NUM_TILES = paths.length;

      /* viewBox → 좌표 변환 */
      let vb = svgElement.getAttribute("viewBox");
      let viewW = 2300, viewH = 2006;
      if (vb) {
        const p = vb.split(/\s+/).map(Number);
        viewW = p[2]; viewH = p[3];
      }

      /* 중심 좌표 저장 */
      GameState.tileCenters = new Array(GameConfig.NUM_TILES);
      paths.forEach(p => {
        const idx = parseInt(p.getAttribute("data-tile-index"), 10);
        const box = p.getBBox();
        GameState.tileCenters[idx] = {
          x: box.x + box.width / 2,
          y: box.y + box.height / 2
        };
      });

      /* 오버레이 생성 */
      GameState.tileElements = new Array(GameConfig.NUM_TILES);
      for (let i = 0; i < GameConfig.NUM_TILES; i++) {
        const path = svgElement.querySelector(`path[data-tile-index="${i}"]`);
        const c = GameState.tileCenters[i];

        const overlay = document.createElement("div");
        overlay.className = "tile-overlay";
        overlay.style.left = (c.x / viewW) * 100 + "%";
        overlay.style.top = (c.y / viewH) * 100 + "%";
        overlay.dataset.tileIndex = i;

        overlay.innerHTML = `
          <div class="tile-bottom">
            <div><span class="label">인구:</span> <span class="pop">0</span></div>
            <div class="tile-pieces"></div>
          </div>
        `;

        overlay.addEventListener("click", e => {
          e.stopPropagation();
          onTileClick(i);
        });
        path.addEventListener("click", e => {
          e.stopPropagation();
          onTileClick(i);
        });

        UI.overlayLayer.appendChild(overlay);

        GameState.tileElements[i] = {
          path,
          overlay,
          pop: overlay.querySelector(".pop"),
          pieces: overlay.querySelector(".tile-pieces")
        };
      }

      buildNeighborMap();
    });
}

/* =============================
   6. 타일 이웃 계산
============================= */
function buildNeighborMap() {
  const N = GameConfig.NUM_TILES;
  const centers = GameState.tileCenters;
  GameState.neighborMap = new Array(N);

  for (let i = 0; i < N; i++) {
    const ci = centers[i];
    if (!ci) continue;

    const dists = [];
    for (let j = 0; j < N; j++) {
      if (i === j) continue;
      const cj = centers[j];
      const dx = cj.x - ci.x;
      const dy = cj.y - ci.y;
      dists.push({ j, dist2: dx * dx + dy * dy });
    }

    dists.sort((a, b) => a.dist2 - b.dist2);

    const base = dists[0].dist2;
    const threshold = base * 2.25;

    GameState.neighborMap[i] = dists
      .filter(d => d.dist2 <= threshold)
      .slice(0, 6)
      .map(d => d.j);
  }
}
/* =============================
   7. 감염 이동 & 감염 확산
============================= */
function stepMovement() {
  for (const e of GameState.entities) {
    if (e.type !== "citizen") continue;
    if (Math.random() < 0.3) {
      const nei = getNeighborIndices(e.tileIndex);
      if (nei.length > 0) {
        e.tileIndex = nei[randInt(nei.length)];
      }
    }
  }
}

function stepInfection() {
  const {
    NUM_TILES,
    BASE_INFECTION_RATE,
    PLAYER_BASE_RATE,
    VACCINE_REDUCTION_FACTOR
  } = GameConfig;

  const state = GameState;

  const tilePop = [...Array(NUM_TILES)].map(() => ({
    citizens: [],
    players: []
  }));

  // 타일별 인구 정리
  for (const e of state.entities) {
    if (e.type === "citizen") tilePop[e.tileIndex].citizens.push(e);
    else tilePop[e.tileIndex].players.push(e);
  }

  const reduction = state.vaccineFeatureEnabled && state.vaccineActive;
  const citizenRate =
    BASE_INFECTION_RATE * (reduction ? VACCINE_REDUCTION_FACTOR : 1);
  const playerRate =
    PLAYER_BASE_RATE * (reduction ? VACCINE_REDUCTION_FACTOR : 1);

  let newInf = 0;

  for (let t = 0; t < NUM_TILES; t++) {
    const tile = tilePop[t];
    const citizens = tile.citizens;
    const players = tile.players;

    const infectedPlayers = players.filter(p => p.infected);
    const infectedCitizens = citizens.filter(c => c.infected);

    // 시민 중 감염 안된 애들
    let healthy = citizens.filter(c => !c.infected && !c.recovered);

    // 감염된 플레이어 → 시민 1명 감염
    for (const p of infectedPlayers) {
      if (healthy.length === 0) break;
      const idx = randInt(healthy.length);
      const target = healthy[idx];

      if (Math.random() < playerRate) {
        target.infected = true;
        target.infectedTurn = GameState.currentTurn;
        newInf++;
      }
      healthy.splice(idx, 1);
    }

    // 감염된 시민 → 시민 2명까지 감염
    healthy = citizens.filter(c => !c.infected && !c.recovered);
    for (const src of infectedCitizens) {
      for (let k = 0; k < 2; k++) {
        if (healthy.length === 0) break;
        const idx = randInt(healthy.length);
        const target = healthy[idx];

        if (Math.random() < citizenRate) {
          target.infected = true;
          target.infectedTurn = GameState.currentTurn;
          newInf++;
        }
        healthy.splice(idx, 1);
      }
    }
  }

  return newInf;
}

/* =============================
   8. 회복 로직 (4턴 후 회복)
============================= */
function stepRecovery() {
  const RECOVERY_TURNS = 4;

  for (const e of GameState.entities) {
    if (e.type !== "citizen") continue;
    if (!e.infected) continue;
    if (e.recovered) continue;

    if (
      e.infectedTurn !== null &&
      GameState.currentTurn - e.infectedTurn >= RECOVERY_TURNS
    ) {
      e.infected = false;
      e.recovered = true;
      e.infectedTurn = null;
    }
  }
}

/* =============================
   9. 렌더링 (타일색 + 말 표시)
============================= */
function renderTiles() {
  const N = GameConfig.NUM_TILES;

  const tiles = [...Array(N)].map(() => ({
    total: 0,
    infected: 0,
    players: 0
  }));

  const tileEntities = [...Array(N)].map(() => ({
    citizens: [],
    players: []
  }));

  for (const e of GameState.entities) {
    const t = tiles[e.tileIndex];
    t.total++;
    if (e.infected) t.infected++;
    if (e.type === "player") {
      tileEntities[e.tileIndex].players.push(e);
    } else {
      tileEntities[e.tileIndex].citizens.push(e);
    }
  }

  for (let i = 0; i < N; i++) {
    const el = GameState.tileElements[i];
    if (!el) continue;

    const t = tiles[i];

    el.pop.textContent = t.total;

    const hasChest =
      GameState.vaccineFeatureEnabled &&
      GameState.activeChestTiles.has(i);

    // 타일 색상
    if (hasChest) {
      el.path.style.fill = "rgba(200,220,255,0.9)";
    } else {
      const ratio = t.total > 0 ? t.infected / t.total : 0;
      if (ratio === 0) el.path.style.fill = "#FAFAFA";
      else {
        const g = Math.round(250 * (1 - ratio));
        const b = Math.round(250 * (1 - ratio));
        el.path.style.fill = `rgb(255,${g},${b})`;
      }
    }

    // 플레이어 말 렌더링
    const pc = el.pieces;
    pc.innerHTML = "";

    for (const p of tileEntities[i].players) {
      const d = document.createElement("div");
      d.className = "piece player" + (p.infected ? " infected" : "");
      pc.appendChild(d);
    }
  }
}

/* =============================
   10. 통계 & 기록
============================= */
function renderStats() {
  const inf = computeInfectedCount();
  const total = GameConfig.NUM_CITIZENS + GameConfig.NUM_PLAYERS;

  UI.statInfected.textContent = inf;
  UI.statRatio.textContent = Math.round((inf / total) * 100) + "%";
  UI.statTurn.textContent = GameState.currentTurn;

  // 히스토리 기록
  if (GameState.lastRecordedTurn !== GameState.currentTurn) {
    GameState.historyCumulativeInfected.push({
      turn: GameState.currentTurn,
      infected: inf
    });
    GameState.lastRecordedTurn = GameState.currentTurn;
  }

  let html = "<b>턴별 누적 감염 인구</b><br>";
  GameState.historyCumulativeInfected.forEach(h => {
    html += `T${h.turn}: ${h.infected}명<br>`;
  });
  UI.infectedHistoryBox.innerHTML = html;

  // 상자/백신 UI
  if (!GameState.vaccineFeatureEnabled) {
    UI.statOpenedChests.textContent = "-";
    UI.statVaccineStatus.textContent = "비활성화";
  } else {
    UI.statOpenedChests.textContent =
      `${GameState.openedChestCount}/${GameConfig.CHESTS_REQUIRED_FOR_VACCINE}`;
    UI.statVaccineStatus.textContent =
      GameState.vaccineActive ? "개발 완료" : "개발 전";
  }
}

function renderAll() {
  renderTiles();
  renderStats();
}

/* =============================
   11. 턴 진행
============================= */
function nextTurn() {
  GameState.currentTurn++;
  GameState.playersMovedThisTurn.clear();

  spawnChestsIfNeeded();
  stepMovement();
  openChestsByPlayers();

  const newInf = stepInfection();
  stepRecovery();

  renderAll();
  addLog(`새 감염자 ${newInf}명`);
}

/* =============================
   12. 초기화
============================= */
function resetGame() {
  GameState.currentTurn = 1;
  GameState.historyCumulativeInfected = [];
  GameState.lastRecordedTurn = 0;

  GameState.activeChestTiles = new Set();
  GameState.chestWave = 0;
  GameState.openedChestCount = 0;
  GameState.vaccineActive = false;

  GameState.selectedPlayer = null;
  GameState.selectedPlayerTileIndex = null;
  GameState.playersMovedThisTurn = new Set();

  UI.logList.innerHTML = "";

  initEntities();
  renderAll();
  addInitialLog();
}

function init() {
  loadSVGMap().then(() => {
    initEntities();
    renderAll();
    addInitialLog();

    UI.nextTurnBtn.addEventListener("click", nextTurn);
    UI.newGameBtn.addEventListener("click", resetGame);
    UI.addDummyLogBtn.addEventListener("click", () => addLog("테스트 로그"));

    UI.vaccineToggle.addEventListener("change", () => {
      GameState.vaccineFeatureEnabled = UI.vaccineToggle.checked;
      addLog(
        GameState.vaccineFeatureEnabled
          ? "백신 시스템 활성화됨"
          : "백신 시스템 비활성화됨"
      );
      renderAll();
    });
  });
}

init();
